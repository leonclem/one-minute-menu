# Railway Workers Environment Configuration
# Copy this file to .env and fill in the values

# ============================================================================
# REQUIRED VARIABLES
# ============================================================================

# Database Configuration
# PostgreSQL connection string for Supabase database
DATABASE_URL=postgresql://postgres:password@db.project.supabase.co:5432/postgres

# Supabase Configuration
# Your Supabase project URL
SUPABASE_URL=https://your-project.supabase.co

# Service role key with full database access (keep secret!)
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Storage Configuration
# Name of the Supabase Storage bucket for export files
STORAGE_BUCKET=export-files

# Email Configuration
# SendGrid API key for sending notification emails
SENDGRID_API_KEY=SG.xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# Email address to send notifications from
SENDGRID_FROM_EMAIL=exports@yourdomain.com

# Worker Configuration
# Unique identifier for this worker instance (e.g., worker-1, worker-2)
WORKER_ID=worker-1

# Puppeteer Configuration
# Path to Chromium executable (set by Dockerfile, usually /usr/bin/chromium)
PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium

# Application Configuration
# Node environment (development, production)
NODE_ENV=production

# Logging level (error, warn, info, debug)
LOG_LEVEL=info


# ============================================================================
# OPTIONAL VARIABLES (with defaults)
# ============================================================================

# Worker Resource Limits
# Maximum number of concurrent Puppeteer instances per worker (default: 3)
MAX_CONCURRENT_RENDERS=3

# Maximum time in seconds for a single export job (default: 60)
JOB_TIMEOUT_SECONDS=60

# Polling Configuration
# Polling interval in milliseconds when jobs are pending (default: 2000)
POLLING_INTERVAL_BUSY_MS=2000

# Polling interval in milliseconds when queue is empty (default: 5000)
POLLING_INTERVAL_IDLE_MS=5000

# Graceful Shutdown
# Maximum time in milliseconds to wait for current job during shutdown (default: 30000)
GRACEFUL_SHUTDOWN_TIMEOUT_MS=30000

# Rate Limiting Configuration
# Maximum exports per hour for free users (default: 10)
FREE_USER_HOURLY_LIMIT=10

# Maximum exports per hour for subscribers (default: 50)
SUBSCRIBER_HOURLY_LIMIT=50

# Maximum pending/processing jobs for free users (default: 5)
FREE_USER_PENDING_LIMIT=5

# Maximum pending/processing jobs for subscribers (default: 20)
SUBSCRIBER_PENDING_LIMIT=20

# Validation Limits
# Maximum menu HTML size in bytes (default: 5242880 = 5MB)
MAX_HTML_SIZE_BYTES=5242880

# Maximum number of images per menu (default: 100)
MAX_IMAGE_COUNT=100

# Retry Configuration
# Base delay in milliseconds for exponential backoff (default: 30000 = 30s)
RETRY_BASE_DELAY_MS=30000

# Maximum retry delay in milliseconds (default: 300000 = 5min)
RETRY_MAX_DELAY_MS=300000

# Maximum number of retry attempts before terminal failure (default: 3)
MAX_RETRY_COUNT=3

# Stale Job Detection
# Time in minutes before a processing job is considered stale (default: 5)
STALE_JOB_THRESHOLD_MINUTES=5

# Interval in minutes to run stale job detection (default: 5)
STALE_JOB_CHECK_INTERVAL_MINUTES=5

# File Cleanup
# Age in days before export files are deleted (default: 30)
FILE_CLEANUP_AGE_DAYS=30

# Interval in hours to run file cleanup (default: 24)
FILE_CLEANUP_INTERVAL_HOURS=24

# Health Check Configuration
# Port for health check endpoint (default: 3000)
HEALTH_CHECK_PORT=3000

# Monitoring and Observability (Optional)
# Sentry DSN for error tracking
# SENTRY_DSN=https://xxxxx@sentry.io/xxxxx

# Datadog API key for metrics
# DATADOG_API_KEY=xxxxx

# Feature Flags (Optional)
# Enable canary export test on worker startup (default: true)
ENABLE_CANARY_EXPORT=true

# Enable circuit breaker for storage failures (default: true)
ENABLE_CIRCUIT_BREAKER=true

# Circuit Breaker Configuration
# Number of consecutive failures before opening circuit (default: 3)
CIRCUIT_BREAKER_FAILURE_THRESHOLD=3

# Cooldown period in milliseconds before attempting to close circuit (default: 60000 = 1min)
CIRCUIT_BREAKER_COOLDOWN_MS=60000

# Network Security
# Comma-separated list of allowed domains for Puppeteer network requests
# Should include Supabase Storage CDN and application domain
ALLOWED_DOMAINS=supabase.co,yourdomain.com

# Memory Management
# Memory usage threshold percentage to stop accepting new jobs (default: 80)
MEMORY_THRESHOLD_PERCENT=80

# Queue Monitoring
# Queue depth threshold for capacity planning warnings (default: 50)
QUEUE_DEPTH_WARNING_THRESHOLD=50

# Signed URL Configuration
# Expiry time in seconds for signed download URLs (default: 604800 = 7 days)
SIGNED_URL_EXPIRY_SECONDS=604800


# ============================================================================
# DEVELOPMENT ONLY
# ============================================================================

# Use local Supabase instance for development
# SUPABASE_URL=http://localhost:54321
# DATABASE_URL=postgresql://postgres:postgres@localhost:54322/postgres

# Disable email sending in development
# SENDGRID_API_KEY=disabled

# Enable verbose logging in development
# LOG_LEVEL=debug

# Reduce polling intervals for faster development feedback
# POLLING_INTERVAL_BUSY_MS=1000
# POLLING_INTERVAL_IDLE_MS=2000
